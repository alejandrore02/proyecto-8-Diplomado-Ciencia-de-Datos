---
title: "Análisis del consumo de alimentos y nutrición"
subtitle: "Equipo 8"
author: 
 - "Corral Robles Leonardo"
 - "Mondragon Velazquez Lorenzo Jesus"
 - "Ruiz Escamilla Alejandro"
date: "2025-11-22"
runtime: shiny
output:
  flexdashboard::flex_dashboard:
    orientation: rows
    vertical_layout: scroll
    theme: cosmo
    source_code: embed
    self_contained: false
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(message = FALSE, warning = FALSE, echo = FALSE)
```



```{r}
#Cargamos toda la librería necesaria para el EDA

library(flexdashboard)
library(WDI) 
library(tidyverse) 
library(janitor)     
library(countrycode) 
library(plotly)
library(RColorBrewer)
library(viridis)
library(ggplot2)
library(kableExtra)
library(htmltools)
library(maps)
library(DT)

```


```{r}
## Se realizó un procesamiento de datos externo debido a que la base de datos es demasiado grande como para desplegarla en una shinny app gratuita. incluimos el archivo usado.

data_filtrada <- readRDS("data/data_filtrada.rds")
```



```{r, results='hide'}
#De acuerdo a la documentación, `area` incluye países, regiones, continentes, grupos económicos, etc.
#Los `area_code` mayores o iguales a 5000 corresponden a agregados (no países), así que generamos subconjuntos.
codigos_area_no_paises <- 5000:5999

data_filtrada <- data_filtrada %>%
  mutate(
    area = str_trim(area),
    area = case_when(
      area == "Taiwan, Province of China" ~ "Taiwan",
      area == "China, Taiwan Province of" ~ "Taiwan",
      area == "Taiwan" ~ "Taiwan",
      area == "China, Hong Kong SAR" ~ "Hong Kong",
      area == "China, Macao SAR" ~ "Macao",
      area == "China, mainland" ~ "China",
      area == "Mainland China" ~ "China",
      area == "People's Republic of China" ~ "China",
      area == "Democratic People's Republic of Korea" ~ "North Korea",
      area == "Republic of Korea" ~ "South Korea",
      TRUE ~ area
    )
  )

data_final_pais <- data_filtrada %>%
  filter(!area_code %in% codigos_area_no_paises) %>%
  rename(pais = area) %>% 
  
  # Agrupaciones de alimentos
  mutate(
    grupos_comida = case_when(
      grepl("Wheat|Rice|Maize|Barley|Oats|Rye|Millet|Sorghum|Cereals|Roots|Potatoes|Cassava|Yams|Sweet potatoes|Starchy Roots", 
            item, ignore.case = TRUE) ~ "CEREALES Y TUBÉRCULOS",
      grepl("Meat|Poultry|Fish|Crustaceans|Molluscs|Cephalopods|Seafood|Offals", 
            item, ignore.case = TRUE) ~ "CARNES Y PESCADOS",
      grepl("Milk|Butter|Cream|Eggs", 
            item, ignore.case = TRUE) ~ "LÁCTEOS Y HUEVOS",
      grepl("Oil|Fat|Groundnut|Sunflowerseed|Sesameseed|Rape and Mustard|Olive|Maize Germ|Coconut|Palm|Cottonseed", 
            item, ignore.case = TRUE) ~ "GRASAS Y ACEITES",
      grepl("Sugar|Sweetener|Honey|Crops", 
            item, ignore.case = TRUE) ~ "AZÚCARES",
      grepl("Fruits|Vegetables|Tomatoes|Oranges|Lemons|Limes|Grapefruit|Dates|Pineapples|Plantains|Onions|Citrus|Grapes|Treenuts", 
            item, ignore.case = TRUE) ~ "FRUTAS Y VERDURAS",
      grepl("Pulses|Beans|Peas|Nuts|Soyabeans", 
            item, ignore.case = TRUE) ~ "LEGUMBRES Y NUECES",
      grepl("Coffee|Tea|Cocoa|Spices|Pimento|Cloves|Stimulants|Wine|Beer|Beverages|Alcoholic",
            item, ignore.case = TRUE) ~ "ESTIMULANTES Y BEBIDAS",
      TRUE ~ "MISCELÁNEOS"
    ),
    region_un = countrycode(pais, origin = 'country.name', destination = 'un.region.name', nomatch = NA_character_),
    continent = countrycode(pais, origin = 'country.name', destination = 'continent', nomatch = NA_character_)
  ) %>%
  mutate(
    region_un = if_else(pais %in% c("Taiwan", "Taiwan, Province of China"), "Eastern Asia", region_un),
    continent = if_else(pais %in% c("Taiwan", "Taiwan, Province of China"), "Asia", continent)
  ) %>%
  filter(!is.na(region_un)) %>%
  mutate(
    periodo_analisis = if_else(year >= 2020, "Post-2020 (Pandemia)", "Pre-2020")
  )

# Base de Datos Región
data_final_region <- data_filtrada %>%
  filter(area_code %in% codigos_area_no_paises) %>%
  mutate(
    aggregation_level = case_when(
      area_code %in% c(5100, 5200, 5300, 5400, 5500, 5000) ~ "Continentes/mundo",
      area_code %in% c(5101:5504) ~ "Sub Región",
      TRUE ~ "Grupo Especial Económico"
    )
  ) %>%
  rename(aggregation_name = area)

# Base de Datos Continentes
data_final_continente <- data_final_region %>%
  filter(aggregation_level == "Continentes/mundo") %>%
  rename(continent_name = aggregation_name)

# Variables para el Dashboard
Lista_paises <- sort(unique(data_final_pais$pais))
Lista_grupos <- sort(unique(data_final_pais$grupos_comida))
```


```{r, results='hide'}
#Preparación de datos para KPIs y visualizaciones globales
# Tomamos el rango de años disponible (en tus datos va 2010–2023)

anio_min <- min(data_final_pais$year, na.rm = TRUE)
anio_max <- max(data_final_pais$year, na.rm = TRUE)

data_periodo <- data_final_pais %>%
filter(year >= anio_min, year <= anio_max)

kpis <- data_periodo %>%
summarise(
kcal_prom = mean(food_supply_kcal_per_capita, na.rm = TRUE),
prot_prom = mean(protein_supply_g_per_capita, na.rm = TRUE),
n_paises  = n_distinct(pais),
n_anios   = n_distinct(year)
)

ts_global <- data_periodo %>%
group_by(year) %>%
summarise(
kcal_prom = mean(food_supply_kcal_per_capita, na.rm = TRUE),
prot_prom = mean(protein_supply_g_per_capita, na.rm = TRUE),
.groups   = "drop"
)

# Tendencias por continente

ts_continente <- data_periodo %>%
group_by(continent, year) %>%
summarise(
kcal_prom = mean(food_supply_kcal_per_capita, na.rm = TRUE),
prot_prom = mean(protein_supply_g_per_capita, na.rm = TRUE),
.groups   = "drop"
)


# Datos para mapa mundial: promedio por país en todo el periodo
map_data_world <- data_periodo %>%
  group_by(pais) %>%
  summarise(
    kcal_prom = mean(food_supply_kcal_per_capita, na.rm = TRUE),
    .groups   = "drop"
  )

# Usamos map_data() de ggplot2, NO de maps
world_map <- ggplot2::map_data("world") %>%
  dplyr::rename(pais = region) %>%
  dplyr::left_join(map_data_world, by = "pais")


# World dietary energy supply by food group (por año y grupo, promediado a nivel mundial)

world_by_group_year <- data_periodo %>%
group_by(year, grupos_comida) %>%
summarise(
kcal_prom = mean(food_supply_kcal_per_capita, na.rm = TRUE),
.groups   = "drop"
)

# Año de foco para 2023 (si no existe, usamos el máximo disponible)

anio_foco <- ifelse(2023 %in% data_final_pais$year, 2023, anio_max)

world_group_2023 <- data_final_pais %>%
filter(year == anio_foco) %>%
group_by(grupos_comida) %>%
summarise(
kcal_prom  = mean(food_supply_kcal_per_capita, na.rm = TRUE),
prot_prom  = mean(protein_supply_g_per_capita, na.rm = TRUE),
.groups    = "drop"
) %>%
arrange(desc(kcal_prom))

world_group_region_2023 <- data_final_pais %>%
filter(year == anio_foco) %>%
group_by(region_un, grupos_comida) %>%
summarise(
kcal_prom = mean(food_supply_kcal_per_capita, na.rm = TRUE),
.groups   = "drop"
)

paleta_continentes <- brewer.pal(5, "Set1")
paleta_grupos      <- viridis::viridis(length(unique(Lista_grupos)), option = "D")

pal_plotly <- RColorBrewer::brewer.pal(6, "Set2")
```

 

```{r, include=FALSE}
##--- PREPARACIÓN ADICIONAL: PROTEÍNAS, MAPA ISO3 Y PIB
world_by_group_year_prot <- data_periodo %>%
  group_by(year, grupos_comida) %>%
  summarise(
    prot_prom = mean(protein_supply_g_per_capita, na.rm = TRUE),
    .groups   = "drop"
  )

# Kcal y proteínas por grupo y región (año foco)
world_group_region_full <- data_final_pais %>%
  filter(year == anio_foco) %>%
  group_by(region_un, grupos_comida) %>%
  summarise(
    kcal_prom = mean(food_supply_kcal_per_capita, na.rm = TRUE),
    prot_prom = mean(protein_supply_g_per_capita, na.rm = TRUE),
    .groups   = "drop"
  )

# Datos para mapa mundial con ISO3 (Plotly)
map_data_world_iso <- data_periodo %>%
  group_by(pais, region_un) %>%  # usamos la región ONU
  summarise(
    kcal_prom = mean(food_supply_kcal_per_capita, na.rm = TRUE),
    prot_prom = mean(protein_supply_g_per_capita, na.rm = TRUE),
    .groups   = "drop"
  ) %>%
  mutate(
    iso3c = countrycode(pais, origin = "country.name", destination = "iso3c"),
    label_kcal = paste0(
      "<b>", pais, "</b><br>",
      "Región ONU: ", region_un, "<br>",
      "kcal/cap/día: ", round(kcal_prom, 1), "<br>",
      "Periodo: ", anio_min, "–", anio_max
    ),
    label_prot = paste0(
      "<b>", pais, "</b><br>",
      "Región ONU: ", region_un, "<br>",
      "g/cap/día: ", round(prot_prom, 2), "<br>",
      "Periodo: ", anio_min, "–", anio_max
    )
  ) %>%
  filter(!is.na(iso3c))


```



```{r, include=FALSE}
indicador_pib <- "NY.GDP.PCAP.CD"

gdp_data_raw <- WDI(
  country   = "all",
  indicator = indicador_pib,
  start     = anio_min,
  end       = anio_max,
  extra     = TRUE
)

gdp_data <- gdp_data_raw %>%
  rename(
    gdp_per_capita = NY.GDP.PCAP.CD
  ) %>%
  filter(!is.na(iso3c)) %>%
  mutate(
    country_std = countrycode(country, origin = "country.name", destination = "country.name")
  ) %>%
  select(country_std, year, gdp_per_capita)

```


```{r, include=FALSE}
## Modelo
model_data <- data_final_pais %>%
  filter(year >= anio_min, year <= anio_max) %>%
  group_by(pais, year, region_un, continent, periodo_analisis) %>%
  summarise(
    total_kcal_pais    = sum(food_supply_kcal_per_capita, na.rm = TRUE),
    total_protein_pais = sum(protein_supply_g_per_capita, na.rm = TRUE),
    .groups            = "drop"
  ) %>%
  mutate(
    country_std = countrycode(pais, origin = "country.name", destination = "country.name")
  ) %>%
  left_join(gdp_data, by = c("country_std", "year")) %>%
  drop_na(gdp_per_capita) %>%
  mutate(
    region_un   = factor(region_un),
    year_factor = factor(year)
  )

model_kcal_supply <- lm(
  total_kcal_pais ~ gdp_per_capita + region_un + year_factor,
  data = model_data
)

model_protein_supply <- lm(
  total_protein_pais ~ gdp_per_capita + region_un + year_factor,
  data = model_data
)

model_data_pred <- model_data %>%
  mutate(
    pred_kcal = as.numeric(predict(model_kcal_supply,   newdata = model_data)),
    pred_prot = as.numeric(predict(model_protein_supply, newdata = model_data))
  )
```
Introducción
============

Row {data-height=230}
--------------------------------

### Bienvenid0

Este dashboard explora el **consumo de alimentos** y su relación con la **nutrición global**, a partir de los datos de  
**FAOSTAT – Food Balance Sheets (FBS)**.

- Analizamos el **suministro calórico** (*food_supply_kcal_per_capita*, en kcal/capita/día)  
  y el **suministro proteico** (*protein_supply_g_per_capita*, en g/capita/día).  
- El periodo de análisis va de **`r anio_min` a `r anio_max`**.  
- Trabajamos a nivel de **país**, **región ONU** y **grupos de alimentos** (cereales, carnes, lácteos, grasas, etc.).  
- Integramos además información económica del **PIB per cápita (Banco Mundial, WDI)** para modelar y explicar patrones.

---

### Hoja de ruta del dashboard

1. **KPIs globales** – indicadores panorámicos de calorías y proteínas.  
2. **Evolución temporal** – tendencias globales y por continente.  
3. **Mapas mundiales** – distribución espacial del suministro de energía y proteínas.  
4. **Grupos de alimentos** – aportes relativos de cereales, carnes, grasas, azúcares, etc.  
5. **Modelo con PIB** – exploración de la relación entre **nivel económico** y **oferta nutricional**.

Row
--------------------------------

### Datos y variables clave

```{r}
tibble::tibble(
  `Elemento`  = c("Fuente principal",
                  "Cobertura temporal",
                  "Cobertura geográfica",
                  "Indicadores nutricionales",
                  "Variables de contexto"),
  `Descripción` = c(
    "FAOSTAT – Food Balance Sheets (FBS)",
    paste(anio_min, anio_max, sep = "–"),
    paste0(kpis$n_paises, " países, agrupados en regiones ONU y continentes"),
    "Food supply (kcal/capita/day) y Protein supply (g/capita/day)",
    "PIB per cápita (WDI, Banco Mundial) + grupos de alimentos"
  )
) |>
  knitr::kable(
    format  = "html",
    caption = "Resumen del conjunto de datos utilizado",
    align   = c("l","l")
  ) |>
  kable_styling(
    full_width        = FALSE,
    bootstrap_options = c("striped","hover","condensed")
  )
```


KPIs y serie global
===================

Row {data-height=160}
--------------------------------

### Oferta calórica global promedio

```{r}
valueBox(
  value   = paste0(round(kpis$kcal_prom, 1), " kcal/cap/día"),
  caption = "Suministro de energía alimentaria (promedio mundial)",
  icon    = "fa-fire",
  color   = "primary"
)
```

### Oferta proteica global promedio

```{r}
valueBox(
value   = paste0(round(kpis$prot_prom, 1), " g/cap/día"),
caption = "Suministro de proteínas (promedio mundial)",
icon    = "fa-cutlery",
color   = "success"
)

```


### Cobertura del análisis FAOSTAT
```{r}
valueBox(
value   = paste0(kpis$n_paises, " países / ", kpis$n_anios, " años"),
caption = "Cobertura del panel (país-año)",
icon    = "fa-globe",
color   = "info"
)

```


Row{data-height=500}
--------------------------------

### Tendencia global de oferta energética y proteica {data-width=100}
```{r}
plot_ly(ts_global, x = ~year) %>%

# Línea principal: kcal

add_lines(
y    = ~kcal_prom,
name = "Energía (kcal/cap/día)",
line = list(width = 3, shape = "spline")
) %>%

# Segunda serie: proteínas (re-escaladas)

add_lines(
y     = ~prot_prom * 50,
name  = "Proteínas (g/cap/día) × 50",
yaxis = "y2",
line  = list(width = 2, dash = "dot", shape = "spline")
) %>%
layout(
title = paste0(
"Evolución global de la oferta energética y proteica (",
anio_min, "–", anio_max, ")"
),
xaxis = list(
title    = "Año",
zeroline = FALSE
),
yaxis = list(
title    = "Energía (kcal/cap/día)",
zeroline = FALSE
),
yaxis2 = list(
title      = "Proteínas (g/cap/día) — escala × 50",
overlaying = "y",
side       = "right",
zeroline   = FALSE
),
legend = list(
orientation = "h",
x           = 0.02,
y           = -0.2
),
margin = list(l = 60, r = 60, t = 60, b = 60)
)

```

Row {data-height=500}
--------
### Oferta energética por continente

```{r}
ts_cont_plot <- ts_continente %>%
mutate(
continente = recode(
continent,
"Africa"        = "África",
"Asia"          = "Asia",
"Europe"        = "Europa",
"North America" = "América del Norte",
"South America" = "América del Sur",
"Oceania"       = "Oceanía",
.default        = continent
)
)

plot_ly(
ts_cont_plot,
x     = ~year,
y     = ~kcal_prom,
color = ~continente,
colors = pal_plotly,
type  = "scatter",
mode  = "lines+markers"
) %>%
layout(
title = "Suministro calórico promedio por continente",
xaxis = list(
title    = "Año",
zeroline = FALSE
),
yaxis = list(
title    = "kcal/cap/día",
zeroline = FALSE
),
legend = list(
orientation = "h",
x           = 0.02,
y           = -0.2
),
margin = list(l = 60, r = 20, t = 60, b = 60)
)

```


### Oferta proteica por continente
```{r}
plot_ly(
ts_cont_plot,
x     = ~year,
y     = ~prot_prom,
color = ~continente,
colors = pal_plotly,
type  = "scatter",
mode  = "lines+markers"
) %>%
layout(
title = "Suministro proteico promedio por continente",
xaxis = list(
title    = "Año",
zeroline = FALSE
),
yaxis = list(
title    = "g/cap/día",
zeroline = FALSE
),
legend = list(
orientation = "h",
x           = 0.02,
y           = -0.2
),
margin = list(l = 60, r = 20, t = 60, b = 60)
)
```

Mapas mundiales
===============
## Controles e información {.sidebar}

### Navegación de esta sección

En esta pestaña se muestran dos mapas coropléticos:

- **Mapa 1:** Oferta calórica promedio (kcal/cap/día).  
- **Mapa 2:** Oferta proteica promedio (g/cap/día).  

Ambos mapas presentan el **promedio por país** en el periodo  
**`r anio_min`–`r anio_max`**, usando datos de FAOSTAT (FBS).

---

### Cómo leer los mapas

- Los colores más **intensos** indican **mayor oferta** del nutriente.  
- Pase el cursor sobre un país para ver:
  - Nombre del país  
  - Región ONU  
  - Valor promedio (kcal o g/cap/día)  
  - Periodo de referencia  

---

Row {data-height=700} 
------

### Mapa mundial de oferta calórica promedio 

```{r}
plot_ly(
map_data_world_iso,
type        = "choropleth",
locations   = ~iso3c,
z           = ~kcal_prom,
text        = ~label_kcal,
hoverinfo   = "text",
colorscale  = "Viridis",
reversescale = FALSE,
marker = list(
line = list(
color = "gray80",
width = 0.2
)
)
) %>%
colorbar(
title = "kcal/cap/día",
len   = 0.6
) %>%
layout(
title = paste0(
"Oferta calórica promedio por país (",
anio_min, "–", anio_max, ")"
),
geo   = list(
showframe      = FALSE,
showcoastlines = FALSE,
projection     = list(type = "robinson"),
lonaxis        = list(showgrid = FALSE),
lataxis        = list(showgrid = FALSE)
),
margin = list(l = 0, r = 0, t = 60, b = 0)
)

```

### Mapa mundial de oferta proteica promedio

```{r}
plot_ly(
map_data_world_iso,
type        = "choropleth",
locations   = ~iso3c,
z           = ~prot_prom,
text        = ~label_prot,
hoverinfo   = "text",
colorscale  = "Plasma",
reversescale = FALSE,
marker = list(
line = list(
color = "gray80",
width = 0.2
)
)
) %>%
colorbar(
title = "g/cap/día",
len   = 0.6
) %>%
layout(
title = paste0(
"Oferta proteica promedio por país (",
anio_min, "–", anio_max, ")"
),
geo   = list(
showframe      = FALSE,
showcoastlines = FALSE,
projection     = list(type = "robinson"),
lonaxis        = list(showgrid = FALSE),
lataxis        = list(showgrid = FALSE)
),
margin = list(l = 0, r = 0, t = 60, b = 0)
)


```

Row {data-height=100}
--------------------------------

### Interpretación general y hallazgos

En esta sección puedes redactar tus **insights clave** a partir de los mapas.  
Ejemplo (ajústalo con base en tus resultados):

- Se observa una **mayor oferta calórica y proteica** en regiones como  
  **Europa**, **América del Norte** y **Oceanía**, frente a niveles más bajos en  
  varias subregiones de **África** y partes de **Asia**.
- La distribución espacial sugiere **desigualdades estructurales** en el acceso  
  a alimentos.


Suministro mundial por grupos de alimentos
==========================================

Row {data-height=600}
---------------------

### Aporte energético global por grupo de alimentos (serie histórica, mundo)

```{r energia_global_hist}
renderPlotly({
  plot_ly(
    world_by_group_year,
    x      = ~year,
    y      = ~kcal_prom,
    color  = ~grupos_comida,
    colors = pal_plotly,
    type   = "bar"
  ) %>%
    layout(
      barmode = "stack",
      title   = paste0(
        "Aporte energético global por grupo de alimentos (",
        anio_min, "–", anio_max, ")"
      ),
      xaxis   = list(title = "Año", zeroline = FALSE),
      yaxis   = list(title = "kcal/capita/día", zeroline = FALSE),
      legend  = list(orientation = "h", x = 0.02, y = -0.2),
      margin  = list(l = 60, r = 20, t = 60, b = 60)
    )
})

```

Row {data-height=500}
---
### Composición promedio del suministro energético mundial por grupo
```{r}
renderPlotly({
df_global_mean <- world_by_group_year %>%
dplyr::group_by(grupos_comida) %>%
dplyr::summarise(
kcal_prom = mean(kcal_prom, na.rm = TRUE),
.groups   = "drop"
) %>%
dplyr::mutate(
share = 100 * kcal_prom / sum(kcal_prom, na.rm = TRUE)
) %>%
dplyr::arrange(dplyr::desc(share))

plot_ly(
df_global_mean,
x          = ~share,
y          = ~reorder(grupos_comida, share),
type       = "bar",
orientation = "h"
) %>%
layout(
title = "Composición promedio del suministro energético mundial por grupo",
xaxis = list(title = "% del suministro energético mundial"),
yaxis = list(title = "Grupo de alimentos"),
margin = list(l = 140, r = 20, t = 60, b = 60)
)
})

```

## Controles análisis detallado {.sidebar}

```{r controles_detalle}
# Años disponibles para el selector
year_choices <- sort(unique(data_periodo$year))

selectInput(
  inputId = "anio_foco",
  label   = "Año de análisis detallado:",
  choices = year_choices,
  selected = anio_foco
)

# Regiones ONU disponibles
region_choices <- sort(unique(data_final_pais$region_un))

selectInput(
  inputId = "region_sel",
  label   = "Filtrar región ONU:",
  choices = c("Todas", region_choices),
  selected = "Todas"
)

HTML("<hr>")
HTML("<p><b>Uso sugerido del análisis detallado:</b><br>
1) Seleccione un año para ver la distribución por grupos.<br>
2) Opcionalmente filtre por región ONU para comparar con el agregado mundial.<br>
3) Use los gráficos para contrastar energía y proteínas por grupo de alimentos.</p>")


```

```{r}
# filtra por año y región seleccionados

world_group_focus <- reactive({
df <- data_final_pais %>%
dplyr::filter(year == input$anio_foco)

if (input$region_sel != "Todas") {
df <- df %>% dplyr::filter(region_un == input$region_sel)
}

df %>%
dplyr::group_by(grupos_comida) %>%
dplyr::summarise(
kcal_prom = mean(food_supply_kcal_per_capita, na.rm = TRUE),
prot_prom = mean(protein_supply_g_per_capita, na.rm = TRUE),
.groups   = "drop"
) %>%
dplyr::arrange(dplyr::desc(kcal_prom))
})

```

Row {data-height=500}
---
### Distribución de energía por grupo (año y región seleccionados)
```{r}
renderPlotly({
df <- world_group_focus()

plot_ly(
df,
x          = ~kcal_prom,
y          = ~reorder(grupos_comida, kcal_prom),
type       = "bar",
orientation = "h",
marker     = list(color = viridis::viridis(nrow(df)))
) %>%
layout(
title = paste0(
"Distribución de energía por grupo — ",
input$anio_foco,
if (input$region_sel != "Todas")
paste0(" (", input$region_sel, ")")
else
" (mundo)"
),
xaxis  = list(title = "kcal/capita/día (promedio)"),
yaxis  = list(title = "Grupo de alimentos"),
margin = list(l = 140, r = 20, t = 60, b = 60)
)
})

```


### Distribución de proteínas por grupo (año y región seleccionados)
```{r}
renderPlotly({
df <- world_group_focus()

plot_ly(
df,
x          = ~prot_prom,
y          = ~reorder(grupos_comida, prot_prom),
type       = "bar",
orientation = "h",
marker     = list(color = viridis::viridis(nrow(df), option = "C"))
) %>%
layout(
title = paste0(
"Distribución de proteínas por grupo — ",
input$anio_foco,
if (input$region_sel != "Todas")
paste0(" (", input$region_sel, ")")
else
" (mundo)"
),
xaxis  = list(title = "g/capita/día (promedio)"),
yaxis  = list(title = "Grupo de alimentos"),
margin = list(l = 140, r = 20, t = 60, b = 60)
)
})

```

Row {data-height=800}
---
### Densidad proteica por grupo de alimentos (año y región seleccionados)

```{r}
renderPlotly({
  df <- world_group_focus() %>%
    dplyr::mutate(
      densidad_proteica = ifelse(
        kcal_prom > 0,
        prot_prom / kcal_prom * 1000,   # g de proteína por 1000 kcal
        NA_real_
      )
    ) %>%
    dplyr::arrange(dplyr::desc(densidad_proteica))

  plot_ly(
    df,
    x          = ~densidad_proteica,
    y          = ~reorder(grupos_comida, densidad_proteica),
    type       = "bar",
    orientation = "h"
  ) %>%
    layout(
      title = paste0(
        "Densidad proteica por grupo de alimentos — ",
        input$anio_foco,
        if (input$region_sel != "Todas")
          paste0(" (", input$region_sel, ")")
        else
          " (mundo)"
      ),
      xaxis = list(title = "g de proteína por 1000 kcal"),
      yaxis = list(title = "Grupo de alimentos"),
      margin = list(l = 160, r = 20, t = 60, b = 60)
    )
})
```


### Comparación por grupo y región ONU (energía, año seleccionado)

```{r}
renderPlotly({
df_region <- data_final_pais %>%
dplyr::filter(year == input$anio_foco) %>%
dplyr::group_by(region_un, grupos_comida) %>%
dplyr::summarise(
kcal_prom = mean(food_supply_kcal_per_capita, na.rm = TRUE),
.groups   = "drop"
)

plot_ly(
df_region,
x      = ~grupos_comida,
y      = ~kcal_prom,
color  = ~region_un,
colors = pal_plotly,
type   = "bar"
) %>%
layout(
barmode = "group",
title   = paste0(
"Energía por grupo de alimentos y región ONU — ",
input$anio_foco
),
xaxis   = list(title = "Grupo de alimentos", tickangle = -45),
yaxis   = list(title = "kcal/cápita/día (promedio)"),
legend  = list(orientation = "h", x = 0.02, y = -0.2),
margin  = list(l = 60, r = 20, t = 60, b = 80)
)
})
```

## Interpretación de las gráficas

### 1. Densidad proteica por grupo de alimentos (año y región seleccionados)

Esta gráfica muestra cuánta proteína aporta cada grupo de alimentos por cada 1000 kilocalorías.  
No representa la cantidad total consumida, sino la **“calidad proteica relativa”** del grupo:

- Valores altos indican alimentos **nutricionalmente densos**, que aportan mucha proteína por unidad de energía.  
- Valores bajos indican alimentos que aportan energía pero **poca proteína** (por ejemplo, azúcares, grasas y algunos cultivos básicos).

Esta visualización permite identificar rápidamente qué grupos de alimentos son más eficientes para cubrir requerimientos proteicos dentro de una dieta.

---

### 2. Energía por grupo y región ONU (año seleccionado)

Esta gráfica compara el aporte energético promedio de cada grupo de alimentos según región ONU.  
Sirve para observar **diferencias estructurales en los patrones alimentarios** del mundo:

- Regiones con mayor dependencia de granos, raíces o tubérculos presentan barras más elevadas para esos grupos.  
- Regiones con un consumo más alto de productos animales o procesados muestran una distribución distinta.  
- Permite contrastar cómo cambia el “perfil energético” de cada región respecto al promedio global.

Esta visualización es útil para identificar **brechas nutricionales regionales**, transiciones alimentarias y patrones culturales asociados al suministro energético.

---

Modelo del suministro alimentario
=================================


## Controles del modelo {.sidebar}

```{r}
# Años disponibles para el modelo
year_choices_modelo <- sort(unique(data_final_pais$year))

sliderInput(
  inputId = "rango_anios_modelo",
  label   = "Rango de años para ajustar el modelo:",
  min     = min(year_choices_modelo, na.rm = TRUE),
  max     = max(year_choices_modelo, na.rm = TRUE),
  value   = c(min(year_choices_modelo, na.rm = TRUE),
              max(year_choices_modelo, na.rm = TRUE)),
  sep     = ""
)

selectInput(
  inputId = "var_modelo",
  label   = "Variable a modelar:",
  choices = c(
    "Calorías (kcal/cápita/día)" = "kcal",
    "Proteínas (g/cápita/día)"   = "prot"
  ),
  selected = "kcal"
)

region_choices_modelo <- sort(unique(data_final_pais$region_un))

selectInput(
  inputId = "region_modelo",
  label   = "Filtrar región ONU (para el ajuste):",
  choices = c("Todas", region_choices_modelo),
  selected = "Todas"
)

# Selector de país para ver predicciones del modelo
pais_choices_modelo <- sort(unique(model_data$pais))

selectInput(
  inputId = "pais_pred",
  label   = "País para predicción (dentro del modelo):",
  choices = c("Ninguno", pais_choices_modelo),
  selected = "Ninguno"
)

HTML("<hr>")
HTML("<p><b>Uso sugerido:</b><br>
1) Elija si desea modelar calorías o proteínas.<br>
2) Ajuste el rango de años del modelo (por ejemplo, 2000–2020).<br>
3) Opcional: filtre por una región ONU para ver solo esos países.<br>
4) Use los gráficos para interpretar la relación entre PIB y oferta alimentaria.<br>
5) Seleccione un país para ver cómo el modelo reproduce y predice sus valores.</p>")

```


```{r}
# Datos filtrados para el modelo según controles

model_data_filtrada <- reactive({
df <- model_data %>%
dplyr::filter(
year >= input$rango_anios_modelo[1],
year <= input$rango_anios_modelo[2]
)

# Filtro opcional por región ONU

if (input$region_modelo != "Todas") {
df <- df %>%
dplyr::filter(region_un == input$region_modelo)
}

# Definir variable dependiente según selección

df <- df %>%
dplyr::mutate(
var_dep = dplyr::case_when(
input$var_modelo == "kcal" ~ total_kcal_pais,
input$var_modelo == "prot" ~ total_protein_pais,
TRUE                       ~ NA_real_
)
) %>%
dplyr::filter(
!is.na(var_dep),
!is.na(gdp_per_capita)
) %>%
dplyr::mutate(
region_un   = droplevels(region_un),
year_factor = droplevels(year_factor)
)

df
})

# Modelo de regresión múltiple reactivo

# Fórmula se adapta según filtros (todas las regiones vs una región, años disponibles, etc.)

modelo_mult <- reactive({
df <- model_data_filtrada()

if (is.null(df) || nrow(df) < 20) {
return(NULL)
}

n_regiones <- length(unique(df$region_un))
n_anios    <- length(unique(df$year_factor))

# Base: siempre incluimos PIB per cápita

if (input$region_modelo == "Todas") {
# Modelo global: puede incluir región_un y/o año como factores si tienen más de un nivel
formula <- var_dep ~ gdp_per_capita


if (n_regiones > 1) {
  formula <- update(formula, . ~ . + region_un)
}
if (n_anios > 1) {
  formula <- update(formula, . ~ . + year_factor)
}


} else {
# Modelo restringido a una sola región:
# no tiene sentido añadir region_un (es constante), pero sí el año si hay más de un año
if (n_anios > 1) {
formula <- var_dep ~ gdp_per_capita + year_factor
} else {
formula <- var_dep ~ gdp_per_capita
}
}

lm(formula, data = df)
})
```

Row {data-height=350}
-------

## PIB per cápita vs oferta total (país-año)
```{r}
renderPlotly({
  df <- model_data_filtrada()

  if (is.null(df) || nrow(df) < 20) {
    return(NULL)
  }

  etiqueta_y <- if (input$var_modelo == "kcal") {
    "Oferta energética total (kcal, suma país-año)"
  } else {
    "Oferta proteica total (g, suma país-año)"
  }

  titulo_graf <- if (input$var_modelo == "kcal") {
    "PIB per cápita vs oferta energética total"
  } else {
    "PIB per cápita vs oferta proteica total"
  }

  subtitulo_reg <- if (input$region_modelo != "Todas") {
    paste0("Región ONU seleccionada: ", input$region_modelo)
  } else {
    "Todas las regiones ONU"
  }

  # Definimos valores de ticks logarítmicos "limpios" en el eje X
  tick_vals <- c(500, 1000, 2000, 5000, 10000, 20000, 50000, 100000)
  tick_txt  <- c("500", "1k", "2k", "5k", "10k", "20k", "50k", "100k")

  plot_ly(
    df,
    x      = ~gdp_per_capita,
    y      = ~var_dep,
    color  = ~region_un,
    colors = pal_plotly,
    type   = "scatter",
    mode   = "markers",
    text   = ~paste0(
      "<b>País:</b> ", pais,
      "<br><b>Año:</b> ", year,
      "<br><b>PIB per cápita:</b> US$ ", formatC(round(gdp_per_capita, 0), big.mark = ","),
      "<br><b>Valor total observado:</b> ", formatC(round(var_dep, 1), big.mark = ","),
      if (input$var_modelo == "kcal") " kcal" else " g de proteína"
    ),
    hoverinfo = "text"
  ) %>%
    layout(
      title  = list(
        text = paste0(
          titulo_graf, "<br><sup>", subtitulo_reg, "</sup>"
        )
      ),
      xaxis  = list(
        title      = "PIB per cápita (US$, escala log10)",
        type       = "log",
        tickvals   = tick_vals,
        ticktext   = tick_txt
      ),
      yaxis  = list(
        title      = etiqueta_y,
        tickformat = ",.0f"
      ),
      legend = list(
        orientation = "h",
        x           = 0.02,
        y           = -0.2
      ),
      margin = list(l = 80, r = 20, t = 70, b = 80),
      height = 400  # fuerza una altura razonable para evitar huecos raros
    )
})

```

Row {data-height=420}
---
### Coeficientes del modelo por región ONU
```{r}
DT::renderDataTable({
mod <- modelo_mult()

if (is.null(mod)) {
return(data.frame(
mensaje = "No hay datos suficientes para estimar el modelo con los filtros actuales (años, región, variable)."
))
}

sm <- summary(mod)

coef_df <- as.data.frame(sm$coefficients) %>%
tibble::rownames_to_column("Termino") %>%
dplyr::rename(
Estimacion     = Estimate,
`Error estandar` = `Std. Error`,
`Valor t`        = `t value`,
`Valor p`        = `Pr(>|t|)`
) %>%
dplyr::mutate(
Estimacion      = round(Estimacion, 2),
`Error estandar` = round(`Error estandar`, 2),
`Valor t`        = round(`Valor t`, 2),
`Valor p`        = round(`Valor p`, 4)
)

# Etiqueta de la variable dependiente y unidades

if (input$var_modelo == "kcal") {
nombre_dep <- "oferta energética total"
unidad_dep <- "kcal totales por país-año"
} else {
nombre_dep <- "oferta proteica total"
unidad_dep <- "gramos de proteína totales por país-año"
}

DT::datatable(
coef_df,
options = list(
pageLength = 10,
dom        = "tip",
ordering   = FALSE
),
caption = htmltools::tags$caption(
style = "caption-side: top; text-align: left;",
htmltools::em(paste0(
"Los coeficientes indican cómo cambia la ", nombre_dep, " (en ", unidad_dep, ") ",
"cuando las variables del modelo cambian:<br>",
"• El coeficiente de gdp_per_capita indica el cambio esperado en la variable dependiente ",
"cuando el PIB per cápita aumenta en 1 US$, manteniendo constantes las demás variables.<br>",
"• Los términos de region_un (cuando aparecen) representan diferencias promedio entre regiones ONU, ",
"respecto a una región base.<br>",
"• Los términos year_factor (cuando aparecen) capturan cambios promedio entre años, ",
"respecto a un año base."
))
)
)
})

```

Row {data-height=460}
---

### Predicción promedio por región (PIB y año típicos del subconjunto)
```{r}
renderPlotly({
mod <- modelo_mult()
df  <- model_data_filtrada()

if (is.null(mod) || is.null(df) || nrow(df) < 20) {
return(NULL)
}

df$pred <- as.numeric(predict(mod, newdata = df))

etiqueta_dep <- if (input$var_modelo == "kcal") {
"Oferta energética total (kcal, país-año)"
} else {
"Oferta proteica total (g, país-año)"
}

plot_ly(
df,
x      = ~var_dep,
y      = ~pred,
color  = ~region_un,
colors = pal_plotly,
type   = "scatter",
mode   = "markers",
text   = ~paste0(
"<b>País:</b> ", pais,
"<br><b>Año:</b> ", year,
"<br><b>Valor observado:</b> ", formatC(round(var_dep, 1), big.mark = ","),
if (input$var_modelo == "kcal") " kcal" else " g de proteína",
"<br><b>Valor predicho:</b> ", formatC(round(pred, 1), big.mark = ","),
if (input$var_modelo == "kcal") " kcal" else " g de proteína"
),
hoverinfo = "text"
) %>%
add_lines(
x = range(df$var_dep, na.rm = TRUE),
y = range(df$var_dep, na.rm = TRUE),
inherit = FALSE,
showlegend = FALSE,
line = list(color = "gray40", dash = "dot")
) %>%
layout(
title = paste0(
"Valores observados vs predichos — ",
if (input$var_modelo == "kcal") "modelo energético" else "modelo proteico"
),
xaxis = list(
title      = paste0(etiqueta_dep, " observado"),
tickformat = ",.0f"
),
yaxis = list(
title      = paste0(etiqueta_dep, " predicho"),
tickformat = ",.0f"
),
legend = list(orientation = "h", x = 0.02, y = -0.2),
margin = list(l = 90, r = 20, t = 70, b = 80)
)
})


```
Row {data-height=450}
---

### Predicción del modelo para el país seleccionado
```{r}
DT::renderDataTable({

# Requiere que el usuario haya elegido un país

if (is.null(input$pais_pred) || input$pais_pred == "Ninguno") {
return(data.frame(
mensaje = "Seleccione un país en el panel lateral para ver las predicciones del modelo."
))
}

mod <- modelo_mult()
df  <- model_data_filtrada()

if (is.null(mod) || is.null(df) || nrow(df) < 20) {
return(data.frame(
mensaje = "No hay datos suficientes para estimar el modelo con los filtros actuales."
))
}

# Subconjunto del país elegido, dentro del rango de años y filtros actuales

df_pais <- df %>%
dplyr::filter(pais == input$pais_pred) %>%
dplyr::arrange(year)

if (nrow(df_pais) == 0) {
return(data.frame(
mensaje = "El país seleccionado no tiene observaciones en el rango de años y región elegidos."
))
}

# Predicciones in-sample del modelo para ese país

df_pais$pred <- as.numeric(predict(mod, newdata = df_pais))

# Etiquetas según variable modelada

if (input$var_modelo == "kcal") {
nom_var   <- "Oferta energética total"
unidad    <- "kcal totales por país-año"
} else {
nom_var   <- "Oferta proteica total"
unidad    <- "gramos de proteína totales por país-año"
}

tabla <- df_pais %>%
dplyr::transmute(
`País`= pais,
`Año`= year,
`PIB per cápita (US$)`= formatC(round(gdp_per_capita, 0), big.mark = ","),
`Valor observado (` = paste0(
formatC(round(var_dep, 1), big.mark = ","),
if (input$var_modelo == "kcal") " kcal" else " g"
),
`Valor predicho por el modelo` = paste0(
formatC(round(pred, 1), big.mark = ","),
if (input$var_modelo == "kcal") " kcal" else " g"
)
)

colnames(tabla)[4] <- paste0("Valor observado (", unidad, ")")
colnames(tabla)[5] <- paste0("Valor predicho (", unidad, ")")

DT::datatable(
tabla,
options = list(
pageLength = 10,
dom        = "tip",
ordering   = FALSE
),
caption = htmltools::tags$caption(
style = "caption-side: top; text-align: left;",
htmltools::em(paste0(
nom_var, " (", unidad, ") para el país seleccionado. ",
"Las predicciones corresponden al modelo ajustado con el rango de años y la región ONU ",
"indicados en el panel lateral. Esta tabla permite comparar, año con año, ",
"los valores observados y los valores que el modelo espera dado el PIB per cápita, ",
"la región y el año."
))
)
)
})

```

Conclusiones
============


Row {data-height=320}
--------------------------------

### 1. ¿Qué países presentan el mayor consumo calórico promedio?

Los países con **mayor consumo calórico promedio** (los colores más claros/amarillos, que representan valores cercanos a **140–150 kcal/capita/día**) son:
+ Estados Unidos  
+ Canadá   
+ Arabia Saudita   
+ Turquía  
+ Algeria   
+ Marruecos   
+ Países Europeos   

---

Row {data-height=320}
--------------------------------

### 2. ¿Cómo ha evolucionado el suministro de calorías o proteínas desde 2000 a 2020?

En general la tendencia ha ido en aumento y podemos analizarla en 3 bloques de tiempo.

La primera de 2010 al 2013, en donde el suministro de proteínas y calorías fue en aumento de forma leve pero continua, lo cual podría significar una estabilidad en la producción de alimentos global.

En el 2014 tenemos una caída abrupta en ambos indicadores, lo cual podría representar la consecuencia de un evento climático o geopolítico.  
En ese año comenzó una movilización militar a gran escala en Ucrania la cual tuvo como consecuencia directa el inicio de la guerra Rusia-Ucrania en 2022. Sin embargo podemos relacionar que este primer gran movimiento del 2014 tuvo un impacto directo en la producción de alimentos de Ucrania, pues se considera que al menos entre 10-15% de productos como maíz, cebada y trigo en el mundo se producen en Ucrania.

Después de 2015 al 2020 tenemos una recuperación sostenida, tanto en calorías como en proteínas, lo cual termina por superar los niveles previos.

---

Row {data-height=320}
--------------------------------

### 3. ¿Qué diferencias se observan entre regiones?

Las diferencias regionales muestran un patrón muy evidente:  
Europa, América del Norte y Oceanía presentan los niveles **más altos** de oferta calórica y proteica, lo cual se interpreta como la existencia de dietas más diversificadas y una amplia disponibilidad de alimentos de origen animal, aceites y productos procesados. Lo cual se puede relacionar directamente con los ingresos reportados de estos países.

**América Latina** ocupa una posición intermedia, con valores más altos en el Cono Sur y más bajos en Centroamérica, resultados que también podemos relacionar directamente con los ingresos de estos países, pues son considerados países con ingresos bajos a medios.

En **Asia** se muestra una marcada heterogeneidad: niveles medio-altos en Asia oriental, intermedios en Medio Oriente y considerablemente más bajos en Asia meridional, donde aún predomina el consumo de cereales. Valores que también se pueden explicar con los ingresos de dichos países.

En contraste, **África** mantiene los niveles más bajos de calorías y proteínas, con una tendencia prácticamente plana entre 2010 y 2020, asociada a dietas menos diversificadas y una mayor vulnerabilidad alimentaria. Resultados que también se explican directamente con los ingresos de los países.

En conjunto, estas diferencias reflejan desigualdades estructurales en acceso, producción y calidad de los alimentos entre regiones del mundo.

---

Row {data-height=320}
--------------------------------

### 4. ¿Existe relación entre el tipo de alimento y el consumo calórico total?

Sí existe una relación directa entre el tipo de alimento predominante en la dieta y el consumo calórico total.

Los datos obtenidos muestran que la mayor parte de las calorías provienen de alimentos con alta densidad energética tales como los **cereales**, los **azúcares** y los **aceites**, que en conjunto representan la base del suministro calórico mundial.

En las regiones donde estos grupos son ampliamente consumidos —como Europa, América del Norte y Oceanía— se observan los niveles más altos de oferta calórica.

Por el contrario, en zonas donde predominan alimentos menos energéticos, como tubérculos, legumbres, frutas y verduras, el consumo calórico es menor, como ocurre en África y partes de Asia meridional.

Esta distribución hace que notemos que la estructura de la dieta influye directamente en el nivel calórico total: **cuanto mayor es la presencia de alimentos energéticamente densos, mayor es el consumo calórico promedio de una región.**

---

Row {data-height=320}
--------------------------------

### 5. ¿Hay evidencia de cambios en los patrones alimentarios (por ejemplo, más productos procesados o menos consumo de cereales)?

No, por lo menos a nivel global, las gráficas no muestran evidencia de cambios relevantes en los patrones alimentarios entre 2010 y 2023.

Los distintos grupos de alimentos mantienen una proporción muy similar en el aporte energético a lo largo de todo el periodo, sin aumentos ni disminuciones significativas.  
Esto indica que la composición general de la dieta global permanece estable.

Por lo tanto, no se observan tendencias claras hacia un posible aumento o reducción de algún grupo de alimentos.  
Es probable que dichos cambios sean visibles si tomamos en cuenta más años de muestra, por ejemplo desde los años 70 hasta la actualidad.

Aun así, es de destacar que **a nivel mundial la proporción de calorías aportadas por el grupo “Misceláneos” es poco más de la mitad**, un dato relevante considerando el contexto actual de **obesidad y diabetes** a nivel mundial.



